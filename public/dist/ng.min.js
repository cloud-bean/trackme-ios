var App=angular.module("starter",["ionic","ionic.utils","starter.controllers","starter.services","starter.filter","starter.common"]).run(["$ionicPlatform",function(r){r.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleLightContent()})}]),AppController=angular.module("starter.controllers",[]),AppService=angular.module("starter.services",[]);
AppController.controller("alarmCtrl",["$scope","WilddogNotifyBaseURL","$ionicLoading","$state","User","Car",function(a,t,n,e,i,r){a.alarmList=[],a.carList=[],0===i.getUsername().length&&e.go("tab.dash");var l=i.getUsername()+"/alarm/",o=new Wilddog(t+l),s=function(){n.show({template:"loading data..."}),r.getAllCars(i.getUsername()).then(function(t){a.carList=t,o.on("value",function(t){a.alarmList=t.val();try{a.$digest()}catch(e){}n.hide()})})["finally"](function(){n.hide()})};s(),a.getCarName=function(t){var n=t,e="unTitled";return t.indexOf("f")>0&&(n=t.substring(0,t.indexOf("f"))),angular.forEach(a.carList,function(a){a.devId+""==n+""&&(e=a.name)}),e}}]);
AppController.controller("carCtrl",["$scope","Car","User","TransData","Talker","$ionicPopup","$ionicLoading","$q","$stateParams","$timeout",function(t,e,a,n,o,r,i,p,l,s){t.latitude="",t.longitude="",t.devInfo=null,t.pointArr=[],t.aMap=new AMap.Map("car_map"),t.carCamerMarker=null,t.isShowCtrlBtn=!1,t.locateMarker=null,t.animationLine=[],t.carState=null,t.address="地址解析中...",t.trackRef="",t.polyline=null,i.show({template:"loading..."}),e.getAllCars(a.getUsername()).then(function(e){var a=null;return angular.forEach(e,function(t,e){e+""==l.id+""&&(a=t)}),i.show({template:"正在获取设备的最新状态..."}),t.car=a,a}).then(function(t){return n.listenOnPosition(t.devId)}).then(function(e){i.show({template:"parse data..."}),t.carState=e,t.latitude=e.lat,t.longitude=e.lon,u(t.latitude,t.longitude,function(e){try{t.address=e.regeocode.formattedAddress,t.$digest()}catch(a){}}),t.showPosition(),i.hide()})["finally"](function(){i.hide()});var u=function(t,e,a){var n,o=[e,t];AMap.service(["AMap.Geocoder"],function(){n=new AMap.Geocoder({radius:1e3,extensions:"all"}),n.getAddress(o,function(t,e){"complete"===t&&"OK"===e.info&&a(e)})})},c=function(e,a,r,p,l){o.sendRequestTrackList(e,a,r,p).then(function(e){t.trackRef=e}),i.show({template:"查询轨迹历史中...<br/>总计需要"+l+"秒"}),s(function(){i.hide(),n.getTrackList(t.trackRef).then(function(e){e.length>0?(t.pointArr=e,null!=t.locateMarker&&t.locateMarker.setMap(null),m(t.aMap,t.pointArr),M(t.aMap,d(t.pointArr)),f(t.aMap),t.showCtrlButtons()):(i.show({template:"无数据或数据量太多，请注意选择时间段"}),s(function(){i.hide()},1200))})},800*l)},m=function(t,e){for(var a=e.length-1;a>=0;a--){var n=e[a];new AMap.Marker({map:t,position:[n.longitude,n.latitude],icon:"http://webapi.amap.com/images/marker_sprite.png",autoRotation:!0})}},d=function(e){for(var a=[],n=0;n<e.length;n++){var o=e[n];a.push([o.longitude.toString(),o.latitude.toString()])}return t.animationLine=a,a},f=function(e){t.carCamerMarker&&(t.carCamerMarker=null);var a=t.pointArr[0];t.carCamerMarker&&t.carCamerMarker.setMap(null),t.carCamerMarker=new AMap.Marker({map:e,position:[a.longitude,a.latitude],icon:"http://code.mapabc.com/images/car_03.png",offset:new AMap.Pixel(-26,-13),autoRotation:!0}),e.setCenter([a.longitude,a.latitude]),e.setZoom(19)},M=function(e,a){t.polyline&&t.polyline.setMap(null),t.polyline=new AMap.Polyline({map:e,path:a,strokeColor:"#00a",strokeOpacity:.4,strokeWeight:3,strokeStyle:"dashed"}),e.setFitView()};t.startAnimation=function(){t.carCamerMarker.moveAlong(t.animationLine,80)},t.stopAnimation=function(){t.carCamerMarker.stopMove(),t.carCamerMarker.setMap(null),f(t.aMap)},t.showCtrlButtons=function(){t.isShowCtrlBtn=!0},t.showPosition=function(){if(""!=t.car.devId&&""!=t.longitude&&""!=t.latitude){t.aMap=t.aMap?t.aMap:new AMap.Map("car_map"),t.aMap.setZoom(19),position=new AMap.LngLat(t.longitude,t.latitude),t.aMap.setCenter(position);var e=new AMap.Marker({position:position,icon:new AMap.Icon({size:new AMap.Size(21,30),image:"img/map-marker.png",imageOffset:new AMap.Pixel(0,0)})});e.setMap(t.aMap),t.locateMarker=e}},t.showPopup=function(){t.timeSpanData={},t.timeSpanData.start_time=new Date,t.timeSpanData.spanHour=1;var e=r.show({templateUrl:"templates/time_span_popup.html",title:"查询起始时间",scope:t,buttons:[{text:"取消"},{text:"<b>查询</b>",type:"button-positive",onTap:function(e){return t.timeSpanData}}]});e.then(function(e){e&&(t.start_time=h(e.start_time),t.end_time=h(new Date(e.start_time.valueOf()-60*parseInt(e.spanHour)*60*1e3)),c(a.getUsername(),t.car.id,t.start_time,t.end_time,parseInt(e.spanHour)))})},t.showDevInfoPopup=function(){r.show({templateFromUrl:"templates/dev_info.html",title:"设备信息",scope:t,buttons:[{type:"button-positive",text:"关闭"}]})};var h=function(t){if(t&&"function"==typeof t.getYear){var e=t.toJSON().split("T");return e[0]+" "+e[1].slice(0,8)}return""}}]);
AppService.factory("Car",["$q","WilddogNotifyBaseURL",function(t,r){return this.carList=[],this.getAllCars=function(i){var n=t.defer(),a=new Wilddog(r+i+"/car");return a.once("value",function(t){this.carList=t.val(),n.resolve(this.carList)},function(t){n.reject(t)}),n.promise},this.getCarByID=function(t){var r;return angular.forEach(this.carList,function(i,n){n===t+""&&(r=i)}),r},this.getCarNameByDevId=function(t){var r="unTitled";return angular.forEach(this.carList,function(i){i.devId+""==t+""&&(r=i.name)}),r},this}]);
AppController.controller("cmdCtrl",["$scope","User","Car","$ionicPopup","$ionicLoading","msg","$state","Command",function(e,n,t,s,o,i,d,c){e.msg=i,e.carList=[],e.selectedOption=null;var l=function(){var s="";s=n.getUsername(),0===s.length&&d.go("tab.dash"),o.show("Loading cars ..."),t.getAllCars(s).then(function(n){e.carList=n})["finally"](function(){o.hide()})};l(),e.clearMsg=function(){e.msg=""},e.selectAction=function(){e.selectedOption=this.selectedOption};var r=function(){if(e.selectedOption)return!0;var n=s.alert({title:"警告",template:"请选择要发送的设备"+e.selectedOption,okText:"明白，好的"});n.then(function(e){return!1})};e.setDefense=function(){return r()?(e.msg="发送 设防指令中...",void c.sendCmd(n.getUsername(),e.selectedOption.devId,e.selectedOption.ipAddress,"set_defense").then(function(n){"ok"===n?e.msg="成功执行 设防指令.":e.msg="未能执行 设防指令.错误原因未知"})):null},e.cancelDefense=function(){return r()?(e.msg="发送 取消设防指令中...",void c.sendCmd(n.getUsername(),e.selectedOption.devId,e.selectedOption.ipAddress,"cancel_defense").then(function(n){"ok"===n?e.msg="成功执行 取消设防指令.":e.msg="未能执行 取消设防指令.错误原因未知"})):null},e.setPowerSupply=function(){return r()?(e.msg="发送设置掉电报警指令中...",void c.sendCmd(n.getUsername(),e.selectedOption.devId,e.selectedOption.ipAddress,"set_power_supply").then(function(n){"ok"===n?e.msg="成功执行 设置掉电报警指令.":e.msg="未能执行 设置掉电报警指令.错误原因未知"})):null},e.cancelPowerSupply=function(){return r()?(e.msg="发送取消掉电报警指令中...",void c.sendCmd(n.getUsername(),e.selectedOption.devId,e.selectedOption.ipAddress,"cancel_power_supply").then(function(n){"ok"===n?e.msg="成功执行取消掉电报警指令.":e.msg="未能执行 取消掉电报警指令.错误原因未知"})):null}}]);
AppService.service("Command",["$q","$http","TranslatorServerURL",function(e,r,n){this.sendCmd=function(o,t,c,d){var i=e.defer(),s="username="+o+"&devid="+t+"&ip="+c;return r({url:n+"/cmd/"+d,method:"POST",data:s,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){i.resolve(e)}).error(function(e){i.reject("error:"+e)}),i.promise}}]);
angular.module("starter.common",[]).constant("TranslatorServerURL","http://120.25.227.156:8080/trackService/rest").constant("WilddogNotifyBaseURL","https://track-translator.wilddogio.com/").constant("Alert",[{code:"64",msg:"非法点火报警"},{code:"11",msg:"超速报警"},{code:"12",msg:"出围栏报警"},{code:"50",msg:"掉电报警"},{code:"12",msg:"出围栏报警"},{code:"14",msg:"终端开机报警"},{code:"01",msg:"SOS报警"},{code:"10",msg:"内置电池低电压报警"},{code:"03",msg:"接触成功"},{code:"33",msg:"脱落报警"},{code:"66",msg:"长时间停留报警"}]);
AppController.controller("DashCtrl",["$scope","Talker","TransData","User","store","$ionicLoading","$timeout",function(e,s,t,n,o,a,i){e.username="",e.password="",e.isAuthed=!1,e.isSaved="true"===o.getSaveConfig()?!0:!1,e.clearSave=function(){e.isSaved=!1,o.setSavedFalse(),o.put("username",""),o.put("password","")},o.getSaveConfig()&&(e.username=o.get("username"),e.password=o.get("password")),e.show=function(e){a.show({template:e})},e.hide=function(){a.hide()},e.toggleSaved=function(){e.isSaved=!e.isSaved,e.isSaved?(o.setSavedTrue(),o.put("username",this.username),o.put("password",this.password)):(o.setSavedFalse(),o.put("username",""),o.put("password",""))},e.login=function(){e.show("正在登陆...");var o=(this.username+"").trim(),a=(this.password+"").trim();n.setUsername(o),s.login(o,a).then(function(e){return t.getLoginResult(e)},function(s){e.show("ref err..."+s)}).then(function(s){e.isAuthed=s.isLogin+""=="1",n.setLoginState(e.isAuthed),e.isAuthed?(e.show("登陆成功！"),i(function(){e.hide()},300)):(e.show("账号或密码错，请重试！"),i(function(){e.hide()},1e3))})},e.logout=function(){var t=e.username;s.logout(t).then(function(e){}),e.isAuthed=!1,n.setLoginState(!1),n.setUsername(""),e.isSaved||(e.username="",e.password="")}}]);
angular.module("starter.filter",[]).filter("parentGroup",function(){return function(r,n){var t=[];return angular.forEach(r,function(r){r.carGroupId===n+""&&t.push(r)}),t}}).filter("cutCharF",function(){return function(r){var n="";return r.indexOf("f")>0&&(n=r.substring(0,r.indexOf("f"))),n}});
AppController.controller("CarGroupCtrl",["$scope","$q","CarGroup","Car","User","$state","$ionicLoading","username",function(n,e,o,t,r,a,l,s){n.groups=[],n.cars=[],n.username=s;var c=o.getGroupList(s).then(function(e){n.groups=e}),i=t.getAllCars(s).then(function(e){n.cars=e}),u=function(){l.show({template:"loading data ..."}),e.all([c,i]).then(function(){l.hide()})["catch"](function(n){l.hide()})};0===n.username.length?a.go("tab.dash"):u(),n.doRefresh=function(){e.all([c,i])["finally"](function(){n.$broadcast("scroll.refreshComplete")})}}]);
AppService.service("CarGroup",["$q","WilddogNotifyBaseURL",function(i,e){this.list=[],this.getGroupList=function(t){var r=new Wilddog(e+t+"/cargroup"),o=i.defer();return r.once("value",function(i){this.list=i.val(),o.resolve(this.list)},function(i){o.reject(i)}),o.promise}}]);
angular.module("ionic.utils",[]).factory("$localstorage",["$window",function(t){return{set:function(o,n){t.localStorage[o]=n},get:function(o,n){return t.localStorage[o]||n},setObject:function(o,n){t.localStorage[o]=JSON.stringify(n)},getObject:function(o){return JSON.parse(t.localStorage[o]||"{}")}}}]);
App.config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("tab",{url:"/tab","abstract":!0,templateUrl:"templates/tabs.html"}).state("tab.dash",{url:"/dash",views:{"tab-dash":{cache:!0,templateUrl:"templates/tab-dash.html",controller:"DashCtrl"}}}).state("tab.groups",{url:"/groups",views:{"tab-groups":{cache:!1,templateUrl:"templates/tab-groups.html",controller:"CarGroupCtrl",resolve:{username:["$q","User",function(t,e){return e.getUsername()}]}}}}).state("cars",{cache:!1,url:"/cars/:id",templateUrl:"templates/car.html",controller:"carCtrl"}).state("alarm",{cache:!1,url:"/alarm",controller:"alarmCtrl",templateUrl:"templates/alarm.html"}).state("cmd",{cache:!1,url:"/cmd",controller:"cmdCtrl",templateUrl:"templates/command.html",resolve:{msg:function(){return""}}}).state("tab.setting",{url:"/setting",views:{"tab-setting":{templateUrl:"templates/tab-setting.html",controller:"SettingCtrl"}}}),e.otherwise("/tab/dash")}]);
AppController.controller("SettingCtrl",["$scope",function(e){e.settings={enableFriends:!0}}]);
App.service("store",["$localstorage",function(t){this.put=function(e,s){t.set(e,s)},this.get=function(e){return t.get(e)},this.getSaveConfig=function(){return t.get("save")},this.setSavedTrue=function(){t.set("save",!0)},this.setSavedFalse=function(){t.set("save",!1)}}]);
AppService.service("Talker",["$http","$q","TranslatorServerURL",function(e,r,t){this.login=function(o,n){var s=r.defer(),c="username="+o+"&password="+n;return e({url:t+"/auth/login",method:"POST",data:c,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){s.resolve(e)}).error(function(e){s.reject("error:"+e)}),s.promise},this.logout=function(o){var n=r.defer();return e({url:t+"/auth/exit/"+o,method:"GET"}).success(function(e){n.resolve(e)}).error(function(e){n.reject("error:"+e)}),n.promise},this.sendRequestTrackList=function(o,n,s,c){var i=r.defer(),u="username="+o+"&carid="+n+"&sdate="+c+"&edate="+s;return e({url:t+"/track/track",method:"POST",data:u,headers:{"Content-Type":"application/x-www-form-urlencoded"},timeout:8e3}).success(function(e,r,t,o){i.resolve(e)}).error(function(e){i.reject("error:"+e)}),i.promise}}]);
AppService.service("TransData",["$q","User","WilddogNotifyBaseURL",function(e,n,t){this.listenOnPosition=function(o){var r=new Wilddog(t+n.getUsername()+"/position/"+o),i=e.defer();return r.on("value",function(e){e.val()?i.resolve(e.val()):i.reject("no data")},function(e){i.reject("The read failed: "+e.code)}),i.promise},this.getTrackList=function(n){var o=new Wilddog(t+n),r=e.defer();return o.once("value",function(e){e.val()?r.resolve(e.val()):r.reject("no data")},function(e){r.reject(e.code)}),r.promise},this.getLoginResult=function(n){var o=e.defer(),r=new Wilddog(t+n);return r.once("value",function(e){var n=e.val();n?o.resolve(n[Object.keys(n)[0]]):o.reject("no data")},function(e){o.reject(e)}),o.promise}}]);
AppService.factory("User",function(){return this.info={username:"",gprsIP:null,gprsPort:null,userType:null,isLogin:!1,uesrid:null},this.setUsername=function(n){this.info.username=n},this.getUsername=function(){return this.info.username},this.getLoginState=function(){return this.info.isLogin},this.setLoginState=function(n){this.info.isLogin=n},this});